<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aurora Odyssey • Portal Fractal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: radial-gradient(circle at 20% 15%, rgba(110, 245, 255, 0.45), transparent 55%),
                   radial-gradient(circle at 80% 35%, rgba(255, 228, 131, 0.4), transparent 60%),
                   linear-gradient(180deg, #02030f 0%, #07153a 45%, #000410 100%);
            --text: rgba(255, 255, 255, 0.92);
            --muted: rgba(255, 255, 255, 0.7);
            --panel: rgba(8, 16, 40, 0.75);
            --accent: #6ef5ff;
            --accent-strong: #ffe483;
            --border: rgba(255, 255, 255, 0.14);
            --shadow: 0 25px 60px rgba(5, 10, 30, 0.38);
            --mono: "IBM Plex Mono", monospace;
            --sans: "Space Grotesk", system-ui, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: var(--sans);
            color: var(--text);
            background: var(--bg);
            min-height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr auto;
        }

        header,
        footer { padding: 2rem clamp(1.5rem, 4vw, 3.5rem); }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
        }

        header a {
            text-decoration: none;
            color: var(--text);
            letter-spacing: 0.22em;
            text-transform: uppercase;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        header svg { width: 1.1rem; height: 1.1rem; }

        main {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: clamp(2rem, 5vw, 3.5rem);
            padding: 0 clamp(1.5rem, 4vw, 3.5rem) clamp(2.5rem, 6vw, 4rem);
        }

        .canvas-wrap {
            position: relative;
            border-radius: 32px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: rgba(5, 9, 24, 0.8);
            box-shadow: var(--shadow);
            min-height: min(70vh, 620px);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            filter: saturate(1.2) contrast(1.2);
        }

        .constellation {
            position: absolute;
            inset: 0;
            pointer-events: none;
            mix-blend-mode: screen;
        }

        .constellation span {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            opacity: 0.7;
            animation: twinkle 6s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.4); }
        }

        .panel {
            border-radius: 28px;
            padding: clamp(1.5rem, 4vw, 2.5rem);
            background: var(--panel);
            border: 1px solid var(--border);
            backdrop-filter: blur(18px);
            box-shadow: var(--shadow);
            display: grid;
            gap: 1.6rem;
            align-content: start;
        }

        h1 { margin: 0; text-transform: uppercase; letter-spacing: 0.18em; font-size: clamp(1.8rem, 3.2vw, 2.6rem); }

        p { margin: 0; color: var(--muted); line-height: 1.8; }

        .control-group { display: grid; gap: 1rem; }

        label { display: grid; gap: 0.45rem; font-size: 0.85rem; letter-spacing: 0.12em; text-transform: uppercase; }

        input[type="range"],
        input[type="text"] { width: 100%; accent-color: var(--accent); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.16); background: rgba(3, 7, 18, 0.65); padding: 0.75rem 1rem; color: var(--text); font-family: var(--sans); }

        .button-row { display: flex; flex-wrap: wrap; gap: 0.75rem; }

        button {
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 0.65rem 1.4rem;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            letter-spacing: 0.18em;
            text-transform: uppercase;
            font-size: 0.75rem;
            cursor: pointer;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }

        button:hover,
        button:focus-visible {
            border-color: var(--accent-strong);
            transform: translateY(-2px);
        }

        .readout {
            font-family: var(--mono);
            font-size: 0.8rem;
            letter-spacing: 0.12em;
            color: var(--accent-strong);
        }

        .preset-panel {
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.16);
            background: rgba(255, 255, 255, 0.05);
            padding: 1.1rem 1.3rem;
            display: grid;
            gap: 1rem;
        }

        .preset-form {
            display: grid;
            gap: 0.75rem;
        }

        .preset-form label {
            margin: 0;
        }

        .preset-list {
            display: grid;
            gap: 0.65rem;
            max-height: 180px;
            overflow: auto;
        }

        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 0.6rem 0.8rem;
            background: rgba(3, 7, 18, 0.6);
            font-family: var(--mono);
            font-size: 0.75rem;
        }

        .preset-item span { flex: 1; letter-spacing: 0.08em; }

        .preset-item button {
            padding: 0.4rem 0.9rem;
            font-size: 0.65rem;
        }

        footer {
            color: var(--muted);
            text-align: center;
            font-size: 0.8rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
        }

        @media (max-width: 820px) {
            header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html">
            <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                <path d="M19 12H5m6 6l-6-6 6-6" />
            </svg>
            Mission Control
        </a>
        <div class="readout" id="status">Orbiting symmetry m = 6.0</div>
    </header>

    <main>
        <div class="canvas-wrap">
            <canvas id="fractal" role="img" aria-label="Animated superformula fractal"></canvas>
            <div class="constellation" aria-hidden="true">
                <span style="top:8%;left:12%;animation-delay:0.6s"></span>
                <span style="top:24%;left:68%;animation-delay:1.4s"></span>
                <span style="top:44%;left:32%;animation-delay:0.2s"></span>
                <span style="top:60%;left:82%;animation-delay:2.1s"></span>
                <span style="top:76%;left:18%;animation-delay:1.9s"></span>
                <span style="top:88%;left:58%;animation-delay:0.9s"></span>
            </div>
        </div>
        <aside class="panel">
            <div>
                <h1>Portal fractal</h1>
                <p>
                    Rendered with Johan Gielis' superformula, this hypershape morphs through cosmic ratios. Adjust symmetry,
                    warp parameters, and freeze the bloom when you land on something sublime. Save presets to revisit your
                    favourite constellations or export a snapshot for the archive.
                </p>
            </div>
            <div class="control-group">
                <label>
                    Symmetry (m)
                    <input id="symmetry" type="range" min="2" max="16" step="0.1" value="6" />
                </label>
                <label>
                    Bloom (n₁)
                    <input id="n1" type="range" min="0.1" max="6" step="0.1" value="0.8" />
                </label>
                <label>
                    Crest (n₂)
                    <input id="n2" type="range" min="0.1" max="6" step="0.1" value="1.7" />
                </label>
                <label>
                    Trough (n₃)
                    <input id="n3" type="range" min="0.1" max="6" step="0.1" value="1.7" />
                </label>
            </div>
            <div class="button-row">
                <button type="button" id="toggle">Pause orbit</button>
                <button type="button" id="randomize">Randomize</button>
                <button type="button" id="reset">Reset</button>
                <button type="button" id="snapshot">Snapshot PNG</button>
            </div>
            <div class="preset-panel">
                <strong style="letter-spacing:0.16em;text-transform:uppercase;font-size:0.75rem;color:var(--accent-strong);">Preset lattice</strong>
                <div class="preset-form">
                    <label>
                        Preset name
                        <input type="text" id="preset-name" placeholder="e.g. Petal-Arc" />
                    </label>
                    <div class="button-row">
                        <button type="button" id="save-preset">Save Preset</button>
                        <button type="button" id="clear-presets">Clear Presets</button>
                    </div>
                </div>
                <div class="preset-list" id="preset-list" aria-live="polite"></div>
            </div>
            <p>
                Tip: Drag the sliders slowly to sculpt petals. Prefer a calmer view? If your system requests reduced motion, the
                fractal animates only when you ask.
            </p>
        </aside>
    </main>

    <footer>Powered by the superformula • Aurora Odyssey Portals</footer>

    <script>
        const canvas = document.getElementById("fractal");
        const ctx = canvas.getContext("2d");
        const symmetry = document.getElementById("symmetry");
        const n1 = document.getElementById("n1");
        const n2 = document.getElementById("n2");
        const n3 = document.getElementById("n3");
        const status = document.getElementById("status");
        const toggleButton = document.getElementById("toggle");
        const randomizeButton = document.getElementById("randomize");
        const resetButton = document.getElementById("reset");
        const snapshotButton = document.getElementById("snapshot");
        const presetName = document.getElementById("preset-name");
        const savePresetButton = document.getElementById("save-preset");
        const clearPresetsButton = document.getElementById("clear-presets");
        const presetList = document.getElementById("preset-list");
        const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        const presetKey = "aurora-fractal-presets";

        let animationFrame;
        let t = 0;
        let lastTimestamp = 0;
        let playing = !prefersReducedMotion;
        let width, height, center;

        const params = {
            m: parseFloat(symmetry.value),
            n1: parseFloat(n1.value),
            n2: parseFloat(n2.value),
            n3: parseFloat(n3.value),
            a: 1,
            b: 1,
        };

        function resize() {
            width = canvas.clientWidth;
            height = canvas.clientHeight;
            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);
            center = { x: width / 2, y: height / 2 };
        }

        function superformula(phi) {
            const { m, n1, n2, n3, a, b } = params;
            const part1 = Math.pow(Math.abs(Math.cos((m * phi) / 4) / a), n2);
            const part2 = Math.pow(Math.abs(Math.sin((m * phi) / 4) / b), n3);
            const r = Math.pow(part1 + part2, -1 / n1);
            return isFinite(r) ? r : 0;
        }

        function advance(timestamp) {
            if (!lastTimestamp) {
                lastTimestamp = timestamp;
            }
            const delta = (timestamp - lastTimestamp) * 0.00025;
            lastTimestamp = timestamp;
            t += delta;
        }

        function renderFrame(timestamp, update = true) {
            if (update) {
                advance(timestamp);
            }
            ctx.clearRect(0, 0, width, height);

            const gradient = ctx.createRadialGradient(center.x, center.y, 0, center.x, center.y, Math.min(width, height) * 0.6);
            gradient.addColorStop(0, "rgba(110, 245, 255, 0.4)");
            gradient.addColorStop(0.5, "rgba(255, 228, 131, 0.2)");
            gradient.addColorStop(1, "rgba(5, 10, 30, 0.9)");
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            ctx.save();
            ctx.translate(center.x, center.y);
            ctx.rotate(t * 0.6);
            ctx.beginPath();

            const petals = 720;
            const scale = Math.min(width, height) * 0.42;

            for (let i = 0; i <= petals; i++) {
                const phi = (i / petals) * Math.PI * 2;
                const radius = superformula(phi) * scale;
                const pulse = 1 + Math.sin(t * 3 + phi * 4) * 0.05;
                const x = radius * Math.cos(phi) * pulse;
                const y = radius * Math.sin(phi) * pulse;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }

            ctx.closePath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = `hsla(${(t * 180) % 360}, 90%, 65%, 0.9)`;
            ctx.stroke();
            ctx.fillStyle = `hsla(${(t * 120 + 200) % 360}, 70%, 55%, 0.35)`;
            ctx.fill("evenodd");
            ctx.restore();
        }

        function draw(timestamp) {
            if (!playing) return;
            renderFrame(timestamp, true);
            animationFrame = requestAnimationFrame(draw);
        }

        function updateStatus() {
            status.textContent = `Orbiting symmetry m = ${params.m.toFixed(1)} • n₁ ${params.n1.toFixed(1)} • n₂ ${params.n2.toFixed(1)} • n₃ ${params.n3.toFixed(1)}`;
        }

        function syncParams() {
            params.m = parseFloat(symmetry.value);
            params.n1 = parseFloat(n1.value);
            params.n2 = parseFloat(n2.value);
            params.n3 = parseFloat(n3.value);
            updateStatus();
            renderStill();
        }

        function renderStill() {
            renderFrame(lastTimestamp || performance.now(), false);
        }

        function captureSnapshot() {
            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            const name = presetName.value.trim() || `fractal-${Date.now()}`;
            link.download = `${name.replace(/\s+/g, "-")}.png`;
            link.click();
        }

        function getPresetPayload() {
            return {
                name: presetName.value.trim() || `Preset ${new Date().toLocaleTimeString()}`,
                params: { ...params },
                timestamp: Date.now(),
            };
        }

        function getPresets() {
            const stored = localStorage.getItem(presetKey);
            if (!stored) return [];
            try {
                return JSON.parse(stored);
            } catch (error) {
                console.warn("Failed to parse presets", error);
                return [];
            }
        }

        function savePresets(list) {
            localStorage.setItem(presetKey, JSON.stringify(list.slice(0, 15)));
        }

        function renderPresets() {
            const presets = getPresets();
            presetList.innerHTML = presets.length
                ? presets
                      .map(
                          (preset, index) => `
                              <div class="preset-item">
                                  <span>${preset.name}</span>
                                  <button type="button" data-index="${index}" data-action="load">Load</button>
                                  <button type="button" data-index="${index}" data-action="delete">Delete</button>
                              </div>
                          `
                      )
                      .join("")
                : '<div style="text-align:center;color:var(--muted);letter-spacing:0.08em;">No presets saved yet.</div>';

            presetList.querySelectorAll("button").forEach((button) => {
                button.addEventListener("click", () => {
                    const index = Number(button.dataset.index);
                    const presets = getPresets();
                    const preset = presets[index];
                    if (button.dataset.action === "load" && preset) {
                        applyPreset(preset);
                    } else if (button.dataset.action === "delete") {
                        presets.splice(index, 1);
                        savePresets(presets);
                        renderPresets();
                    }
                });
            });
        }

        function applyPreset(preset) {
            const { m, n1: pn1, n2: pn2, n3: pn3 } = preset.params;
            params.m = m;
            params.n1 = pn1;
            params.n2 = pn2;
            params.n3 = pn3;
            symmetry.value = m;
            n1.value = pn1;
            n2.value = pn2;
            n3.value = pn3;
            syncParams();
        }

        function resetParams() {
            params.m = 6;
            params.n1 = 0.8;
            params.n2 = 1.7;
            params.n3 = 1.7;
            symmetry.value = params.m;
            n1.value = params.n1;
            n2.value = params.n2;
            n3.value = params.n3;
            presetName.value = "";
            syncParams();
            t = 0;
            lastTimestamp = 0;
            renderStill();
        }

        symmetry.addEventListener("input", syncParams);
        n1.addEventListener("input", syncParams);
        n2.addEventListener("input", syncParams);
        n3.addEventListener("input", syncParams);

        toggleButton.addEventListener("click", () => {
            playing = !playing;
            toggleButton.textContent = playing ? "Pause orbit" : "Play orbit";
            if (playing) {
                lastTimestamp = performance.now();
                animationFrame = requestAnimationFrame(draw);
            } else {
                cancelAnimationFrame(animationFrame);
                renderStill();
            }
        });

        randomizeButton.addEventListener("click", () => {
            params.m = Number((Math.random() * 12 + 3).toFixed(1));
            params.n1 = Number((Math.random() * 4 + 0.4).toFixed(1));
            params.n2 = Number((Math.random() * 4 + 0.6).toFixed(1));
            params.n3 = Number((Math.random() * 4 + 0.6).toFixed(1));
            symmetry.value = params.m;
            n1.value = params.n1;
            n2.value = params.n2;
            n3.value = params.n3;
            syncParams();
            renderStill();
        });

        resetButton.addEventListener("click", resetParams);
        snapshotButton.addEventListener("click", captureSnapshot);

        savePresetButton.addEventListener("click", () => {
            const payload = getPresetPayload();
            const presets = getPresets();
            presets.unshift(payload);
            savePresets(presets);
            renderPresets();
        });

        clearPresetsButton.addEventListener("click", () => {
            localStorage.removeItem(presetKey);
            renderPresets();
        });

        window.addEventListener("resize", () => {
            resize();
            renderStill();
        });

        resize();
        syncParams();
        renderPresets();
        if (playing) {
            lastTimestamp = performance.now();
            animationFrame = requestAnimationFrame(draw);
        } else {
            renderStill();
        }
    </script>
</body>
</html>
